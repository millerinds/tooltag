<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão App - Administração</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8e8e8 0%, #f5f5f5 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body.modal-open {
            overflow: hidden;
        }

        .main-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        .main-panel {
            flex: 1;
            padding: clamp(10px, 2vw, 20px);
            margin-right: 0;
        }

        .header {
            text-align: center;
            color: #2c3e50;
            margin-bottom: clamp(20px, 3vw, 30px);
        }

        .header h1 {
            font-size: clamp(20px, 5vw, 28px);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: clamp(12px, 2.5vw, 14px);
            color: #7f8c8d;
            font-weight: 500;
        }

        .filter-section {
            display: flex;
            gap: clamp(10px, 2vw, 15px);
            margin-bottom: clamp(15px, 3vw, 25px);
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .filter-button {
            padding: clamp(8px, 2vw, 12px) clamp(16px, 3vw, 24px);
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            font-size: clamp(12px, 2.5vw, 14px);
        }

        .filter-button.active {
            background: #3498db;
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .filter-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.2);
        }

        .create-button {
            padding: clamp(8px, 2vw, 12px) clamp(16px, 3vw, 24px);
            border: 2px solid #27ae60;
            background: #27ae60;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            font-size: clamp(12px, 2.5vw, 14px);
        }

        .create-button:hover {
            background: #219653;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.2);
        }

        .search-box {
            padding: clamp(8px, 2vw, 12px) clamp(15px, 3vw, 20px);
            border: 2px solid #bdc3c7;
            border-radius: 25px;
            font-size: clamp(12px, 2.5vw, 14px);
            width: 100%;
            max-width: 500px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .items-list {
            background: white;
            border-radius: 15px;
            padding: clamp(10px, 2vw, 20px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: clamp(20px, 3vw, 30px);
        }

        .item-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: clamp(10px, 2vw, 15px);
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        .item-row:hover {
            background: #f8f9fa;
        }

        .item-row.ferramenta {
            border-left: 4px solid #2c3e50;
        }

        .item-row.insumo {
            border-left: 4px solid #34495e;
        }

        .item-type {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: clamp(10px, 2vw, 12px);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: clamp(10px, 2vw, 15px);
        }

        .item-type.ferramenta {
            background: #2c3e50;
        }

        .item-type.insumo {
            background: #34495e;
        }

        .item-title {
            flex: 1;
            font-size: clamp(14px, 3vw, 16px);
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .item-title .item-link { color: inherit; text-decoration: none; }
        .item-title .item-link:hover { text-decoration: underline; }

        .item-code {
            font-size: clamp(12px, 2.5vw, 14px);
            color: #7f8c8d;
            margin-right: clamp(10px, 2vw, 20px);
            font-family: 'Courier New', monospace;
        }

        .item-details {
            font-size: clamp(11px, 2.2vw, 13px);
            color: #555;
            margin-right: clamp(10px, 2vw, 20px);
            flex-basis: 100%;
            margin-top: 5px;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: flex-end;
            width: 100%;
        }

        .edit-button {
            padding: clamp(6px, 1.5vw, 8px) clamp(12px, 2.5vw, 16px);
            background: #f39c12;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: clamp(10px, 2vw, 12px);
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .edit-button:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .delete-button {
            padding: clamp(6px, 1.5vw, 8px) clamp(12px, 2.5vw, 16px);
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: clamp(10px, 2vw, 12px);
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .delete-button:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .sidebar {
            position: fixed;
            right: 0;
            top: 0;
            width: clamp(250px, 80vw, 400px);
            height: 100vh;
            background: white;
            box-shadow: -2px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: clamp(15px, 3vw, 20px);
            text-align: center;
            position: relative;
        }

        .sidebar-header h2 {
            font-size: clamp(16px, 3.5vw, 18px);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: clamp(11px, 2.5vw, 13px);
            opacity: 0.9;
        }

        .load-all-button {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: clamp(10px, 2vw, 15px) auto 0;
            width: 40px;
            height: 40px;
            background: #3498db;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .load-all-button:hover {
            background: #2980b9;
            border-color: rgba(255, 255, 255, 0.8);
            transform: scale(1.1);
        }

        .solicitations-list {
            padding: clamp(15px, 3vw, 20px);
            display: flex;
            flex-direction: column;
            gap: clamp(10px, 2vw, 15px);
        }

        .solicitation-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: clamp(10px, 2vw, 15px);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border-left: 3px solid #e74c3c;
            display: flex;
            justify-content: space-between;
            align-items: center;
            overflow: hidden;
        }

        .solicitation-item:hover {
            background: #e3f2fd;
            transform: translateX(-5px);
        }

        .solicitation-item.unread {
            border-left-width: 4px;
        }

        .solicitation-item.unread::before {
            content: '';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 8px;
            height: 8px;
            background: #e74c3c;
            border-radius: 50%;
        }

        .solicitation-item.baixa {
            border-left-color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }

        .solicitation-item.baixa.unread::before {
            background: #27ae60;
        }

        .solicitation-item.media {
            border-left-color: #f39c12;
            background: rgba(243, 156, 18, 0.1);
        }

        .solicitation-item.media.unread::before {
            background: #f39c12;
        }

        .solicitation-item.alta {
            border-left-color: #e62222;
            background: rgba(230, 126, 34, 0.1);
        }

        .solicitation-item.alta.unread::before {
            background: #e62222;
        }

        .solicitation-item.critica {
            border-left-color: #8e44ad;
            background: rgba(142, 68, 173, 0.1);
        }

        .solicitation-item.critica.unread::before {
            background: #8e44ad;
        }

        .solicitation-content {
            flex: 1;
            min-width: 0;
        }

        .solicitation-title {
            font-size: clamp(12px, 2.5vw, 14px);
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .solicitation-type {
            font-size: clamp(10px, 2vw, 12px);
            color: #7f8c8d;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .solicitation-date {
            font-size: clamp(9px, 2vw, 11px);
            color: #95a5a6;
        }

        .solicitation-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .solicitation-delete {
            padding: clamp(4px, 1.5vw, 6px) clamp(8px, 2vw, 12px);
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: clamp(9px, 2vw, 10px);
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .solicitation-delete:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .sidebar-toggle {
            position: fixed;
            top: clamp(10px, 2vw, 20px);
            right: clamp(10px, 2vw, 20px);
            background: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            display: none;
        }

        .sidebar-toggle:hover {
            background: #2980b9;
        }

        .back-button {
            position: fixed;
            bottom: clamp(20px, 4vw, 30px);
            left: clamp(20px, 4vw, 30px);
            width: clamp(40px, 10vw, 60px);
            height: clamp(40px, 10vw, 60px);
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .back-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1002;
            overflow-y: auto;
            align-items: flex-start;
            justify-content: center;
            padding: clamp(10px, 2vw, 20px);
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: clamp(15px, 3vw, 20px);
            width: 100%;
            max-width: clamp(300px, 90vw, 500px);
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            margin: clamp(10px, 2vw, 20px) 0;
            position: relative;
        }

        .modal-content h2 {
            font-size: clamp(16px, 3.5vw, 18px);
            color: #2c3e50;
            margin-bottom: clamp(15px, 3vw, 20px);
        }

        .modal-content label {
            display: block;
            font-size: clamp(12px, 2.5vw, 14px);
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: clamp(8px, 2vw, 10px);
            margin-bottom: clamp(10px, 2vw, 15px);
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            font-size: clamp(12px, 2.5vw, 14px);
            outline: none;
        }

        .modal-content input:focus,
        .modal-content select:focus {
            border-color: #3498db;
        }

        .insumo-search {
            position: relative;
        }

        .insumo-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1003;
            display: none;
        }

        .insumo-search-result {
            padding: clamp(8px, 2vw, 10px);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .insumo-search-result:hover {
            background: #e3f2fd;
        }

        .modal-content button {
            padding: clamp(8px, 2vw, 10px) clamp(15px, 3vw, 20px);
            background: #3498db;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: clamp(12px, 2.5vw, 14px);
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .modal-content button:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .modal-content button.cancel {
            background: #95a5a6;
        }

        .modal-content button.cancel:hover {
            background: #7f8c8d;
        }

        .confirmation-modal .modal-content {
            max-width: clamp(280px, 80vw, 400px);
            text-align: center;
        }

        .confirmation-modal p {
            font-size: clamp(12px, 2.5vw, 14px);
            color: #2c3e50;
            margin-bottom: clamp(15px, 3vw, 20px);
        }

        .loading {
            text-align: center;
            padding: clamp(20px, 5vw, 40px);
            color: #7f8c8d;
        }

        .no-items {
            text-align: center;
            padding: clamp(20px, 5vw, 40px);
            color: #7f8c8d;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: clamp(15px, 3vw, 20px);
            border-radius: 10px;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1004;
            opacity: 1;
            transition: opacity 0.5s ease;
            font-size: clamp(14px, 3vw, 16px);
            background-color: rgba(0, 0, 0, 0.8);
            text-align: center;
            min-width: clamp(200px, 50vw, 300px);
        }

        .notification.success {
            background-color: rgba(39, 174, 96, 0.9);
        }

        .notification.error {
            background-color: rgba(231, 76, 60, 0.9);
        }

        .undo-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: clamp(15px, 3vw, 20px);
            border-radius: 10px;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1004;
            opacity: 1;
            transition: opacity 0.5s ease;
            font-size: clamp(14px, 3vw, 16px);
            background-color: rgba(231, 76, 60, 0.9);
            text-align: center;
            min-width: clamp(200px, 50vw, 300px);
            display: none;
        }

        .undo-notification button {
            background: #e67e22;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 5px 10px;
            cursor: pointer;
            margin-left: 10px;
            transition: background 0.3s ease;
        }

        .undo-notification button:hover {
            background: #d35400;
        }

        .required {
            color: #e74c3c;
        }

        @media (min-width: 769px) {
            .main-panel {
                margin-right: clamp(250px, 30vw, 400px);
            }

            .sidebar {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .main-panel {
                padding: clamp(10px, 3vw, 15px);
            }

            .sidebar {
                width: 100%;
            }

            .sidebar-toggle {
                display: flex;
            }

            .filter-section {
                flex-direction: column;
                gap: 10px;
            }

            .item-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .item-title, .item-code, .item-details, .item-actions {
                margin-bottom: 5px;
            }

            .modal-content {
                width: 95%;
                max-height: 85vh;
                padding: clamp(10px, 2vw, 15px);
            }
        }

        @media (max-width: 480px) {
            .filter-button, .create-button {
                font-size: clamp(10px, 2.5vw, 12px);
                padding: clamp(6px, 2vw, 10px) clamp(12px, 3vw, 20px);
            }

            .search-box {
                font-size: clamp(10px, 2.5vw, 12px);
            }

            .item-title {
                font-size: clamp(12px, 3vw, 14px);
            }

            .item-details {
                font-size: clamp(10px, 2.5vw, 12px);
            }

            .edit-button {
                font-size: clamp(9px, 2vw, 10px);
            }

            .delete-button {
                font-size: clamp(9px, 2vw, 10px);
            }

            .modal-content button {
                font-size: clamp(10px, 2.5vw, 12px);
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="main-panel">
            <div class="header">
                <h1>Administração</h1>
                <p>Gerenciar ferramentas e insumos cadastrados</p>
            </div>

            <div class="filter-section">
                <button class="filter-button active" data-filter="todos" onclick="filterItems('todos', this)">
                    Todos os Itens
                </button>
                <button class="filter-button" data-filter="ferramenta" onclick="filterItems('ferramenta', this)">
                    Ferramentas
                </button>
                <button class="filter-button" data-filter="insumo" onclick="filterItems('insumo', this)">
                    Insumos
                </button>
                <button class="create-button" onclick="window.location.href='/cadastro'" aria-label="Cadastrar um novo item">
                    Cadastrar Item
                </button>
                <input type="text" class="search-box" placeholder="Buscar por nome ou código..." onkeyup="searchItems(this.value)">
            </div>

            <div class="items-list" id="itemsList">
                <div class="loading">Carregando itens...</div>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Solicitações Pendentes</h2>
                <p>Últimas solicitações recebidas</p>
            </div>
            
            <div class="solicitations-list" id="solicitationsList">
                <div class="loading">Carregando solicitações...</div>
                <button class="load-all-button" id="loadAllButton" onclick="loadAllSolicitations(event)" title="Carregar todas as solicitações">
                    +
                </button>
            </div>
        </div>
    </div>

    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" title="Abrir/Fechar Sidebar">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
        </svg>
    </button>

    <button class="back-button" onclick="goBack()" title="Voltar ao Menu">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
    </button>


    <div class="modal confirmation-modal" id="confirmationModal">
        <div class="modal-content">
            <h2>Confirmar Exclusão</h2>
            <p id="confirmationMessage"></p>
            <button onclick="confirmDeletion()">Confirmar</button>
            <button class="cancel" onclick="closeModal('confirmationModal')">Cancelar</button>
        </div>
    </div>

    <div class="undo-notification" id="undoNotification">
        <span id="undoMessage"></span>
        <button id="undoButton" onclick="undoDeletion()">Desfazer</button>
        <span id="undoCountdown"></span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        let allItems = [];
        let filteredItems = [];
        let currentFilter = 'todos';
        let pendingDeletion = null;
        let deletionTimeout = null;
        let deletedItemId = null;
        let solicitations = [];
        let allSolicitations = [];
        let showingAllSolicitations = false;

        const socket = io('/gestao', { transports: ['websocket', 'polling'] });

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Página inicializada');
            loadItems();
            loadSolicitations();

            socket.on('connect', () => {
                console.log('Conectado ao WebSocket no namespace /gestao');
            });

            socket.on('connect_error', (error) => {
                console.error('Erro de conexão WebSocket:', error);
                showNotification('Erro ao conectar ao servidor. Tente novamente.', true);
            });

            socket.on('disconnect', () => {
                console.log('Desconectado do WebSocket');
            });

            socket.on('new_solicitation', (solicitation) => {
                console.log('Nova solicitação recebida via WebSocket:', solicitation);
                if (!solicitation || !solicitation.id || !solicitation.nome_item || !['insumo', 'ocorrencia', 'ferramenta'].includes(solicitation.tipo)) {
                    console.warn('Solicitação inválida recebida:', solicitation);
                    return;
                }

                const newSolicitation = {
                    id: solicitation.id,
                    titulo: solicitation.nome_item || solicitation.titulo || 'Solicitação sem nome',
                    tipo: solicitation.tipo || 'insumo',
                    data: solicitation.data || 'Data não informada',
                    urgencia: solicitation.urgencia || solicitation.prioridade || 'baixa',
                    status: solicitation.status || 'Pendente',
                    visualizada: solicitation.status !== 'Pendente'
                };

                allSolicitations = allSolicitations.filter(sol => !(sol.id === newSolicitation.id && sol.tipo === newSolicitation.tipo));
                solicitations = solicitations.filter(sol => !(sol.id === newSolicitation.id && sol.tipo === newSolicitation.tipo));

                allSolicitations.unshift(newSolicitation);

                if (showingAllSolicitations) {
                    solicitations.unshift(newSolicitation);
                } else {
                    solicitations.unshift(newSolicitation);
                    if (solicitations.length > 5) {
                        solicitations = solicitations.slice(0, 5);
                    }
                }

                renderSolicitations(solicitations);
                updateLoadAllButton();
                showNotification(`Nova solicitação recebida: ${newSolicitation.titulo}`, false);
            });
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
            console.log('Alternando sidebar:', sidebar.classList.contains('open') ? 'Aberta' : 'Fechada');
        }

        function loadItems() {
            console.log('Carregando itens de /api/itens_cadastro...');
            fetch('/api/itens_cadastro')
                .then(response => {
                    if (!response.ok) throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
                    return response.json();
                })
                .then(data => {
                    console.log('Itens recebidos:', data);
                    allItems = data;
                    filteredItems = [...allItems];
                    renderItems();
                })
                .catch(error => {
                    console.error('Erro ao carregar itens:', error);
                    document.getElementById('itemsList').innerHTML = `<div class="no-items">Erro ao carregar itens: ${error.message}</div>`;
                    showNotification(`Erro ao carregar itens: ${error.message}`, true);
                });
        }

        function renderItems() {
            const list = document.getElementById('itemsList');
            console.log('Renderizando itens:', filteredItems);
            if (filteredItems.length === 0) {
                list.innerHTML = '<div class="no-items">Nenhum item encontrado</div>';
                return;
            }

            try {
                list.innerHTML = filteredItems.map(item => {
                    console.log('Renderizando item:', item);
                    const safeNome = (item.nome_descricao || item.nome || 'Sem nome').replace(/"/g, '&quot;');
                    return `
                        <div class="item-row ${item.tipo_item || ''}">
                            <span class="item-type ${item.tipo_item || ''}">${item.tipo_item || 'N/A'}</span>
                            <div class="item-title"><a class="item-link" href="/editor?id=${item.id || 0}" title="Abrir item para editar">${safeNome}</a></div>
                            <div class="item-code">Código: ${item.codigo_interno || 'N/A'}</div>
                            <div class="item-details">
                                Categoria: ${item.categoria || 'N/A'} | 
                                Material: ${item.material || 'N/A'} | 
                                Altura: ${item.altura_min || 0}-${item.altura_max || 0}mm | 
                                RPM: ${item.rpm || 'N/A'} | 
                                Avanço: ${item.avanco || 'N/A'}mm/min
                            </div>
                            <div class="item-actions">
                                <button class="edit-button" onclick="editItem(${item.id || 0})">Editar</button>
                                <button class="delete-button" onclick="showConfirmationModalItem(${item.id || 0}, '${safeNome}')">Excluir</button>
                            </div>
                        </div>
                    `;
                }).join('');

                const elements = list.querySelectorAll('.item-row');
                elements.forEach((element, index) => {
                    element.style.opacity = '0';
                    element.style.transform = 'translateY(20px)';
                    element.style.transition = 'all 0.3s ease';
                    setTimeout(() => {
                        element.style.opacity = '1';
                        element.style.transform = 'translateY(0)';
                    }, index * 100);
                });
            } catch (error) {
                console.error('Erro ao renderizar itens:', error);
                list.innerHTML = '<div class="no-items">Erro ao renderizar itens</div>';
                showNotification('Erro ao renderizar itens.', true);
            }
        }

        function loadSolicitations() {
            console.log('Carregando solicitações de /api/insumos e /api/ocorrencias...');
            Promise.all([
                fetch('/api/insumos').then(res => {
                    if (!res.ok) throw new Error(`Erro em insumos: ${res.statusText}`);
                    return res.json();
                }),
                fetch('/api/ocorrencias').then(res => {
                    if (!res.ok) throw new Error(`Erro em ocorrências: ${res.statusText}`);
                    return res.json();
                })
            ])
                .then(([insumos, ocorrencias]) => {
                    console.log('Insumos recebidos:', insumos);
                    console.log('Ocorrências recebidas:', ocorrencias);
                    allSolicitations = [
                        ...insumos
                            .filter(item => {
                                if (!item.id || item.id <= 0) {
                                    console.warn('Insumo com ID inválido:', item);
                                    return false;
                                }
                                return true;
                            })
                            .map(item => ({
                                id: item.id,
                                titulo: item.nome_item || item.nome || 'Insumo sem nome',
                                tipo: item.tipo || 'insumo',
                                data: item.data || 'Data não informada',
                                urgencia: item.urgencia || 'baixa',
                                status: item.status || 'Pendente',
                                visualizada: item.status !== 'Pendente',
                                codigo_interno: item.codigo_interno_item || item.codigo_interno || ''
                            })),
                        ...ocorrencias
                            .filter(item => {
                                if (!item.id || item.id <= 0) {
                                    console.warn('Ocorrência com ID inválido:', item);
                                    return false;
                                }
                                return true;
                            })
                            .map(item => ({
                                id: item.id,
                                titulo: item.titulo || 'Ocorrência sem título',
                                tipo: item.tipo || 'ocorrencia',
                                data: item.data || 'Data não informada',
                                urgencia: item.prioridade || 'baixa',
                                status: item.status || 'Aberta',
                                visualizada: item.status !== 'Aberta'
                            }))
                    ].sort((a, b) => {
                        const parseDate = (dateStr) => {
                            try {
                                if (!dateStr || dateStr === 'Data não informada') return new Date(0);
                                const [date, time] = dateStr.split(' ');
                                const [day, month, year] = date.split('/');
                                return new Date(`${year}-${month}-${day}T${time || '00:00'}:00`);
                            } catch (e) {
                                console.warn(`Erro ao parsear data: ${dateStr}`, e);
                                return new Date(0);
                            }
                        };
                        return parseDate(b.data) - parseDate(a.data);
                    });
                    
                    allSolicitations.forEach(sol => {
                        if (sol.tipo !== 'insumo' && sol.tipo !== 'ocorrencia' && sol.tipo !== 'ferramenta') {
                            console.warn('Solicitação com tipo inválido:', sol);
                        }
                    });
                    
                    solicitations = allSolicitations.slice(0, 5);
                    showingAllSolicitations = false;
                    
                    console.log('Solicitações processadas:', solicitations);
                    renderSolicitations(solicitations);
                    updateLoadAllButton();
                })
                .catch(error => {
                    console.error('Erro ao carregar solicitações:', error);
                    document.getElementById('solicitationsList').innerHTML = `<div class="no-items">Erro ao carregar solicitações: ${error.message}</div>`;
                    showNotification(`Erro ao carregar solicitações: ${error.message}`, true);
                });
        }

        function loadAllSolicitations(event) {
            event.stopPropagation();
            console.log('Alternando visualização de todas as solicitações');
            if (showingAllSolicitations) {
                solicitations = allSolicitations.slice(0, 5);
                showingAllSolicitations = false;
                showNotification('Mostrando apenas as últimas 5 solicitações', false);
            } else {
                solicitations = [...allSolicitations];
                showingAllSolicitations = true;
                showNotification(`Carregadas todas as ${allSolicitations.length} solicitações`, false);
            }
            
            renderSolicitations(solicitations);
            updateLoadAllButton();
        }

        function updateLoadAllButton() {
            const button = document.getElementById('loadAllButton');
            if (button) {
                if (showingAllSolicitations) {
                    button.innerHTML = '-';
                    button.title = 'Mostrar apenas as últimas 5';
                } else {
                    button.innerHTML = '+';
                    button.title = `Carregar todas as ${allSolicitations.length} solicitações`;
                }
            }
        }

        function renderSolicitations(solicitationsList) {
            const list = document.getElementById('solicitationsList');
            console.log('Renderizando solicitações:', solicitationsList);
            if (!solicitationsList || solicitationsList.length === 0) {
                console.warn('âNenhuma solicitação para renderizar.');
                list.innerHTML = '<div class="no-items">Nenhuma solicitação encontrada</div><button class="load-all-button" id="loadAllButton" onclick="loadAllSolicitations(event)" title="Carregar todas as solicitações">+</button>';
                return;
            }

            try {
                list.innerHTML = solicitationsList.filter(sol => sol.id && ['insumo', 'ocorrencia', 'ferramenta'].includes(sol.tipo)).map(sol => {
                    console.log('Renderizando solicitação:', sol);
                    const safeTitulo = (sol.titulo || 'Sem título').replace(/"/g, '&quot;');
                    const validTipo = ['insumo', 'ocorrencia'].includes(sol.tipo) ? sol.tipo : 'insumo';
                    return `
                        <div class="solicitation-item ${sol.urgencia} ${!sol.visualizada ? 'unread' : ''}" data-id="${sol.id}">
                            <div class="solicitation-content" onclick="event.stopPropagation(); viewSolicitation(${sol.id}, '${validTipo}')">
                                <div class="solicitation-title">${ (['insumo'].includes(validTipo) && (sol.codigo_interno || sol.codigo_interno_item)) ? `<a href="/ficha?codigo_interno=${encodeURIComponent(sol.codigo_interno || sol.codigo_interno_item)}" class="solicitation-link" onclick="event.stopPropagation();">${safeTitulo}</a>` : safeTitulo }</div>
                                <div class="solicitation-type">${validTipo}</div>
                                <div class="solicitation-date">${sol.data}</div>
                            </div>
                            <div class="solicitation-actions">
                                <button class="solicitation-delete" onclick="event.stopPropagation(); showConfirmationModal(${sol.id}, '${validTipo}', '${safeTitulo}')">Excluir</button>
                            </div>
                        </div>
                    `;
                }).join('') + '<button class="load-all-button" id="loadAllButton" onclick="loadAllSolicitations(event)" title="Carregar todas as solicitações">+</button>';

                const elements = list.querySelectorAll('.solicitation-item');
                elements.forEach((element, index) => {
                    element.style.opacity = '0';
                    element.style.transform = 'translateY(20px)';
                    element.style.transition = 'all 0.3s ease';
                    setTimeout(() => {
                        element.style.opacity = '1';
                        element.style.transform = 'translateY(0)';
                    }, index * 100);
                });
            } catch (error) {
                console.error('Erro ao renderizar solicitações:', error);
                list.innerHTML = '<div class="no-items">Erro ao renderizar solicitações</div><button class="load-all-button" id="loadAllButton" onclick="loadAllSolicitations(event)" title="Carregar todas as solicitações">+</button>';
                showNotification('Erro ao renderizar solicitações.', true);
            }
        }

        function showConfirmationModalItem(id, nome) {
            console.log('Mostrando modal de confirmação para item:', { id, nome });
            pendingDeletion = { id, tipo: 'item', nome, titulo: nome };
            document.getElementById('confirmationMessage').innerHTML = `Tem certeza que deseja excluir o item "${nome}"?`;
            openModal('confirmationModal');
        }

        function showConfirmationModal(id, tipo, titulo) {
            console.log('Mostrando modal de confirmação:', { id, tipo, titulo });
            if (!['insumo', 'ocorrencia'].includes(tipo)) {
                console.error('Tipo inválido ao mostrar modal:', tipo);
                showNotification('Tipo de solicitação inválido.', true);
                return;
            }
            pendingDeletion = { id, tipo, titulo };
            document.getElementById('confirmationMessage').innerHTML = `Tem certeza que deseja excluir a ${tipo} "${titulo}"?`;
            openModal('confirmationModal');
        }

        function confirmDeletion() {
            if (!pendingDeletion) {
                console.warn('Nenhuma exclusão pendente.');
                showNotification('Nenhuma exclusão pendente.', true);
                return;
            }
            const { id, tipo, nome, titulo } = pendingDeletion;
            console.log('Confirmando exclusão:', { id, tipo, nome, titulo });
            let url;
            if (tipo === 'item') {
                url = `/api/itens_cadastro/${id}`;
            } else if (tipo === 'insumo') {
                url = `/api/insumo/${id}`;
            } else if (tipo === 'ocorrencia') {
                url = `/api/ocorrencia/${id}`;
            } else {
                console.error('Tipo de solicitação inválido:', tipo);
                showNotification('Tipo de solicitação inválido.', true);
                closeModal('confirmationModal');
                return;
            }
            fetch(url, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => {
                    console.log('Resposta da exclusão:', response);
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || `HTTP ${response.status}`); });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Exclusão bem-sucedida:', data);
                    closeModal('confirmationModal');
                    if (tipo === 'item') {
                        deletedItemId = id;
                        showUndoNotification(`Item "${nome}" excluído com sucesso!`, id);
                        loadItems();
                    } else {
                        showNotification(`${tipo.charAt(0).toUpperCase() + tipo.slice(1)} "${titulo}" excluído com sucesso!`, false);
                        solicitations = solicitations.filter(sol => sol.id !== id);
                        allSolicitations = allSolicitations.filter(sol => sol.id !== id);
                        renderSolicitations(solicitations);
                        updateLoadAllButton();
                    }
                })
                .catch(error => {
                    console.error('Erro ao excluir:', error);
                    closeModal('confirmationModal');
                    showNotification(`Erro ao excluir: ${error.message}`, true);
                });
            pendingDeletion = null;
        }

        function showUndoNotification(message, id) {
            console.log('Mostrando notificação de desfazer com ID:', id);
            const notification = document.getElementById('undoNotification');
            const undoMessage = document.getElementById('undoMessage');
            const undoButton = document.getElementById('undoButton');
            const undoCountdown = document.getElementById('undoCountdown');
            undoMessage.textContent = message;
            notification.style.display = 'block';
            let timeLeft = 10;

            undoCountdown.textContent = ` (Desfazer em ${timeLeft}s)`;
            deletionTimeout = setInterval(() => {
                timeLeft--;
                undoCountdown.textContent = ` (Desfazer em ${timeLeft}s)`;
                if (timeLeft <= 0) {
                    clearInterval(deletionTimeout);
                    notification.style.opacity = '0';
                    setTimeout(() => notification.style.display = 'none', 500);
                }
            }, 1000);

            undoButton.onclick = () => undoDeletion(id);
        }

        function undoDeletion(id) {
            console.log('Desfazendo exclusão do item:', id);
            fetch(`/api/itens_cadastro/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ undo: true })
            })
                .then(response => {
                    console.log('Resposta do desfazimento:', response);
                    if (!response.ok) {
                        if (response.status === 409) {
                            throw new Error('Não foi possível desfazer: o código interno já está em uso.');
                        }
                        return response.json().then(err => { throw new Error(err.error || `HTTP ${response.status}`); });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Desfazimento bem-sucedido:', data);
                    const notification = document.getElementById('undoNotification');
                    clearInterval(deletionTimeout);
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        notification.style.display = 'none';
                        loadItems();
                    }, 500);
                    showNotification('Exclusão desfeita com sucesso!', false);
                })
                .catch(error => {
                    console.error('Erro ao desfazer exclusão:', error);
                    showNotification(`Erro ao desfazer: ${error.message}`, true);
                });
            deletedItemId = null;
        }

        function showNotification(message, isError = false) {
            console.log(`Notificação: ${message}, Erro: ${isError}`);
            const notification = document.createElement('div');
            notification.className = `notification ${isError ? 'error' : 'success'}`;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        function openModal(modalId) {
            console.log(`Abrindo modal: ${modalId}`);
            document.getElementById(modalId).style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function closeModal(modalId) {
            console.log(`Fechando modal: ${modalId}`);
            document.getElementById(modalId).style.display = 'none';
            document.body.classList.remove('modal-open');
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
        }

        function filterItems(filter, button) {
            console.log('Aplicando filtro:', filter);
            document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            currentFilter = filter;
            applyFilters();
        }

        function searchItems(query) {
            console.log('Buscando com query:', query);
            applyFilters(query.toLowerCase());
        }

        function applyFilters(searchQuery = '') {
            filteredItems = allItems.filter(item => {
                const matchesFilter = currentFilter === 'todos' || item.tipo_item === currentFilter;
                const matchesSearch = searchQuery === '' ||
                    (item.nome_descricao || item.nome || '').toLowerCase().includes(searchQuery) ||
                    (item.codigo_interno || '').toLowerCase().includes(searchQuery);
                return matchesFilter && matchesSearch;
            });
            console.log('Itens filtrados:', filteredItems);
            renderItems();
        }


        function editItem(id) {
            console.log('Redirecionando para editor do item:', id);
            const url = `/editor?id=${id}`
            window.location.href = url;
        }


        // Removido logout automático ao sair â€” mantÃ©m sessão ativa entre fluxos internos

        function viewSolicitation(id, tipo) {
            console.log('Visualizando solicitação:', { id, tipo });
            if (!id || isNaN(id)) {
                console.error('ID inválido:', id);
                showNotification('ID de solicitação inválido.', true);
                return;
            }
            
            // Aceitar tanto 'insumo' quanto 'ocorrencia' e 'ferramenta'
            if (!['ocorrencia', 'insumo', 'ferramenta'].includes(tipo)) {
                console.error('Tipo de solicitação inválido:', tipo);
                showNotification('Tipo de solicitação inválido.', true);
                return;
            }
            
            // Para insumos e ferramentas, usar a página de atender_insumo
            // Para ocorrÃªncias, vocÃª pode criar uma página especÃ­fica ou adaptar
            let url;
            if (tipo === 'insumo' || tipo === 'ferramenta') {
                url = `/visualinsumo?id=${id}`;
            } else if (tipo === 'ocorrencia') {
                // Por enquanto redirecionar para uma página de visualização de ocorrÃªncia
                // VocÃª pode criar uma página especÃ­fica ou adaptar a existente
                url = `/visualocorrencia?id=${id}`;
            } else {
                // Fallback para insumo
                url = `/visualinsumo?id=${id}`;
            }
            
            console.log('Redirecionando para:', url);
            window.location.href = url;
            
            // Fechar sidebar em dispositivos móveis
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
            }
            
            // Marcar como visualizada
            const item = document.querySelector(`.solicitation-item[data-id="${id}"]`);
            if (item) {
                item.classList.remove('unread');
                console.log('Marca de "não lido" removida para solicitação:', id);
            } else {
                console.warn('Item da solicitação não encontrado para ID:', id);
            }
        }

        function goBack() {
            console.log('Voltando para a página inicial');
            window.location.href = '/';
        }


        window.addEventListener('load', () => {
            console.log('Aplicando animações de entrada');
            const elements = document.querySelectorAll('.item-row, .solicitation-item');
            elements.forEach((element, index) => {
                element.style.opacity = '0';
                element.style.transform = 'translateY(20px)';
                element.style.transition = 'all 0.3s ease';
                setTimeout(() => {
                    element.style.opacity = '1';
                    element.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });

        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const toggle = document.getElementById('sidebarToggle');
                if (!sidebar.contains(e.target) && !toggle.contains(e.target) && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                }
            }
        });
        // Redefine comportamento do botão Voltar para usar o histórico
        function goBack() {
            window.history.back();
        }
    </script>
</body>
</html>
