<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitar Insumo ou Ferramenta - Gest√£o App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* [Previous CSS styles remain unchanged] */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8e8e8 0%, #f5f5f5 100%);
            min-height: 100vh;
            padding: 1rem;
            margin: 0;
        }

        .container {
            max-width: 48rem;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        .header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
            border-radius: 0.75rem 0.75rem 0 0;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .form-label.required::after {
            content: ' *';
            color: #e74c3c;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #bdc3c7;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background: #fafafa;
            transition: border-color 0.3s ease;
        }

        .form-input:focus,
        .form-textarea:focus {
            border-color: #3498db;
            background: white;
            outline: none;
        }

        .form-input:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
        }

        .form-textarea {
            min-height: 5rem;
            resize: vertical;
        }

        .search-input {
            position: relative;
            z-index: 10;
        }

        #searchResults {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            max-height: 15rem;
            overflow-y: auto;
            background: white;
            border: 2px solid #3498db;
            border-radius: 0 0 0.5rem 0.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 100000;
            display: none;
            padding: 0.5rem 0;
        }

        .search-result-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

        .search-result-item:hover {
            background: #e3f2fd;
        }

        .result-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.875rem;
        }

        .result-code {
            font-size: 0.75rem;
            color: #7f8c8d;
            font-family: 'Courier New', monospace;
            background: #ecf0f1;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .result-type {
            font-size: 0.7rem;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .selected-item {
            background: #e8f5e8;
            border: 2px solid #27ae60;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            z-index: 5;
        }

        .selected-item-info {
            flex: 1;
        }

        .selected-item-name {
            font-weight: 600;
            color: #27ae60;
            font-size: 0.875rem;
        }

        .selected-item-code {
            font-size: 0.75rem;
            color: #7f8c8d;
            font-family: 'Courier New', monospace;
        }

        .remove-item-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .remove-item-btn:hover {
            background: #c0392b;
            transform: rotate(90deg);
        }

        .urgency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(6rem, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .urgency-option {
            position: relative;
        }

        .urgency-radio {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .urgency-label {
            display: block;
            padding: 0.75rem;
            border: 2px solid #bdc3c7;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            background: #fafafa;
            transition: all 0.3s ease;
        }

        .urgency-radio:checked + .urgency-label {
            color: white;
        }

        .urgency-radio[value="baixa"]:checked + .urgency-label {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            border-color: #27ae60;
        }

        .urgency-radio[value="media"]:checked + .urgency-label {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            border-color: #f39c12;
        }

        .urgency-radio[value="alta"]:checked + .urgency-label {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-color: #e74c3c;
        }

        .urgency-radio[value="critica"]:checked + .urgency-label {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            border-color: #8e44ad;
        }

        .quantity-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .quantity-btn {
            width: 2.5rem;
            height: 2.5rem;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1.25rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .quantity-btn:hover {
            background: #3498db;
            color: white;
        }

        .quantity-input {
            width: 5rem;
            text-align: center;
            padding: 0.75rem;
            border: 2px solid #bdc3c7;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: bold;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 8rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9, #3498db);
        }

        .btn-primary:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
        }

        .back-button {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            width: 3rem;
            height: 3rem;
            background: linear-gradient(135deg, #34495e, #2c3e50);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            transform: scale(1.1);
        }

        .notification {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 500;
            opacity: 1;
            transition: opacity 0.5s ease;
            font-size: 0.875rem;
            text-align: center;
            min-width: 15rem;
        }

        .notification.success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .notification.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .dialog-box {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            max-width: 24rem;
            width: 90%;
            text-align: center;
        }

        .dialog-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .dialog-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .dialog-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 8rem;
        }

        .dialog-btn-primary {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .dialog-btn-primary:hover {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .dialog-btn-secondary {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
        }

        .dialog-btn-secondary:hover {
            background: linear-gradient(135deg, #2c3e50, #34495e);
        }

        @media (max-width: 768px) {
            .container {
                max-width: 90%;
                padding: 1rem;
            }

            .form-input,
            .form-textarea {
                font-size: 1rem;
                padding: 1rem;
            }

            .urgency-grid {
                grid-template-columns: 1fr;
            }

            .quantity-btn {
                width: 3rem;
                height: 3rem;
                font-size: 1.5rem;
            }

            .quantity-input {
                width: 6rem;
                padding: 1rem;
                font-size: 1rem;
            }

            .form-actions {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                padding: 1rem;
                font-size: 1rem;
            }

            .back-button {
                bottom: 1rem;
                left: 1rem;
            }

            .dialog-box {
                width: 95%;
                padding: 1rem;
            }

            .dialog-actions {
                flex-direction: column;
                gap: 0.75rem;
            }

            .dialog-btn {
                width: 100%;
                padding: 1rem;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .urgency-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Solicitar Insumo ou Ferramenta</h1>
            <p>Fa√ßa sua solicita√ß√£o de forma r√°pida</p>
        </div>

        <div class="form-container">
            <form id="solicitacaoForm" method="POST">
                <div class="form-group">
                    <label class="form-label required">Item Solicitado (Insumo ou Ferramenta)</label>
                    <div class="search-input">
                        <input 
                            type="text" 
                            class="form-input" 
                            id="itemSearch" 
                            placeholder="Digite para buscar insumo ou ferramenta..."
                            autocomplete="off"
                        >
                    </div>
                    <div id="selectedItemContainer"></div>
                    <input type="hidden" id="selectedItemId" name="item_id" required>
                    <input type="hidden" id="selectedItemName" name="nome">
                </div>

                <div class="form-group">
                    <label class="form-label required">Nome do Operador</label>
                    <input 
                        type="text" 
                        class="form-input" 
                        name="operador" 
                        placeholder="Digite seu nome completo"
                        required
                    >
                </div>

                <div class="form-group">
                    <label class="form-label required">M√°quina/Setor</label>
                    <input 
                        type="text" 
                        class="form-input" 
                        name="maquina" 
                        placeholder="Ex: Torno CNC-01"
                        required
                    >
                </div>

                <div class="form-group">
                    <label class="form-label required">Quantidade</label>
                    <div class="quantity-container">
                        <button type="button" class="quantity-btn" onclick="adjustQuantity(-1)">‚àí</button>
                        <input 
                            type="number" 
                            class="quantity-input" 
                            id="quantityInput"
                            name="quantidade" 
                            value="1" 
                            min="1" 
                            max="9999"
                            required
                        >
                        <button type="button" class="quantity-btn" onclick="adjustQuantity(1)">+</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label required">N√≠vel de Urg√™ncia</label>
                    <div class="urgency-grid">
                        <div class="urgency-option">
                            <input type="radio" class="urgency-radio" id="baixa" name="urgencia" value="baixa" required>
                            <label class="urgency-label" for="baixa">Baixa</label>
                        </div>
                        <div class="urgency-option">
                            <input type="radio" class="urgency-radio" id="media" name="urgencia" value="media">
                            <label class="urgency-label" for="media">M√©dia</label>
                        </div>
                        <div class="urgency-option">
                            <input type="radio" class="urgency-radio" id="alta" name="urgencia" value="alta">
                            <label class="urgency-label" for="alta">Alta</label>
                        </div>
                        <div class="urgency-option">
                            <input type="radio" class="urgency-radio" id="critica" name="urgencia" value="critica">
                            <label class="urgency-label" for="critica">Cr√≠tica</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label required">Justificativa</label>
                    <textarea 
                        class="form-textarea" 
                        name="justificativa" 
                        placeholder="Descreva o motivo da solicita√ß√£o..."
                        required
                    ></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">Enviar</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="goBack()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <button class="back-button" onclick="goBack()" title="Voltar ao Menu">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.42-1.41L7.83 13H20v-2z"/>
        </svg>
    </button>

    <div id="searchResults"></div>

    <div id="successDialog" class="dialog-overlay">
        <div class="dialog-box">
            <div class="dialog-title">Solicita√ß√£o Enviada!</div>
            <p>Deseja fazer uma nova solicita√ß√£o ou voltar ao menu inicial?</p>
            <div class="dialog-actions">
                <button class="dialog-btn dialog-btn-primary" onclick="newRequest()">Fazer Outra Solicita√ß√£o</button>
                <button class="dialog-btn dialog-btn-secondary" onclick="goBack()">Voltar ao Menu</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // Initialize SocketIO
        const socket = io('/gestao', { transports: ['websocket', 'polling'] });

        let allItems = [];
        let selectedItem = null;
        let searchTimeout = null;
        let isLoadingItems = false;

        document.addEventListener('DOMContentLoaded', () => {
            loadItems();
            setupEventListeners();

            // WebSocket connection events
            socket.on('connect', () => {
                console.log('‚úÖ Conectado ao WebSocket no namespace /gestao');
            });
            socket.on('connect_error', (error) => {
                console.error('‚ùå Erro de conex√£o WebSocket:', error);
                showNotification('Erro ao conectar ao servidor. Tente novamente.', true);
            });
            socket.on('disconnect', () => {
                console.log('üîå Desconectado do WebSocket');
            });
        });

        function setupEventListeners() {
            const itemSearch = document.getElementById('itemSearch');
            const form = document.getElementById('solicitacaoForm');
            const quantityInput = document.getElementById('quantityInput');

            itemSearch.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => searchItems(e.target.value), 300);
            });

            // Mostrar sugestes somente quando clicar (focus) na caixa
            itemSearch.addEventListener('focus', () => {
                searchItems(itemSearch.value || '');
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-input') && !e.target.closest('.dialog-box')) {
                    hideSearchResults();
                }
            });

            quantityInput.addEventListener('input', validateQuantity);

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                submitForm();
            });
        }

        function loadItems() {
            const itemSearch = document.getElementById('itemSearch');
            itemSearch.disabled = true;
            itemSearch.placeholder = 'Carregando itens...';
            isLoadingItems = true;

            fetch('/api/itens_cadastro')
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    return response.json();
                })
                .then(data => {
                    allItems = data;
                    itemSearch.disabled = false;
                    itemSearch.placeholder = 'Digite para buscar insumo ou ferramenta...';
                    if (allItems.length === 0) {
                        showNotification('Nenhum item dispon√≠vel.', true);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Erro ao carregar itens:', error);
                    showNotification(`Erro ao carregar itens: ${error.message}`, true);
                    itemSearch.disabled = true;
                    itemSearch.placeholder = 'Erro ao carregar itens';
                })
                .finally(() => {
                    isLoadingItems = false;
                });
        }

        function searchItems(query) {
            if (isLoadingItems) {
                showNotification('Aguarde o carregamento dos itens.', true);
                return;
            }

            const searchResults = document.getElementById('searchResults');
            const inputRect = document.getElementById('itemSearch').getBoundingClientRect();
            const inputEl = document.getElementById('itemSearch');
            const term = (query || '').toLowerCase();
            // Mostrar apenas quando focado e houver termo
            if (document.activeElement !== inputEl || term.length === 0) {
                hideSearchResults();
                return;
            }

            const ranked = allItems
                .filter(item => {
                    const nome = (item.nome_descricao || '').toLowerCase();
                    const codigo = (item.codigo_interno || '').toLowerCase();
                    return nome.includes(term) || codigo.includes(term);
                })
                .map(item => {
                    const nome = (item.nome_descricao || '').toLowerCase();
                    const codigo = (item.codigo_interno || '').toLowerCase();
                    const cStarts = codigo.startsWith(term) ? 0 : 1;
                    const nStarts = nome.startsWith(term) ? 0 : 1;
                    const cIndex = codigo.indexOf(term);
                    const nIndex = nome.indexOf(term);
                    return { item, key: [cStarts, nStarts, cIndex === -1 ? 9999 : cIndex, nIndex === -1 ? 9999 : nIndex, codigo.length, nome.length] };
                })
                .sort((a, b) => {
                    for (let i = 0; i < a.key.length; i++) {
                        if (a.key[i] !== b.key[i]) return a.key[i] - b.key[i];
                    }
                    return 0;
                })
                .slice(0, 5)
                .map(x => x.item);

            searchResults.innerHTML = ranked.length === 0
                ? '<div class="search-result-item">Nenhum item encontrado</div>'
                : ranked.map(item => `
                    <div class="search-result-item" onclick="selectItem(${item.id}, '${escapeHtml(item.nome_descricao)}', '${escapeHtml(item.codigo_interno)}', '${escapeHtml(item.tipo_item)}')">
                        <span class="result-name">${escapeHtml(item.nome_descricao)}</span>
                        <span class="result-code">${escapeHtml(item.codigo_interno)}</span>
                        <span class="result-type">(${escapeHtml(item.tipo_item)})</span>
                    </div>
                `).join('');

            searchResults.style.display = 'block';
            searchResults.style.top = `${inputRect.bottom + window.scrollY}px`;
            searchResults.style.left = `${inputRect.left + window.scrollX}px`;
            searchResults.style.width = `${inputRect.width}px`;
        }

        function selectItem(id, nome, codigo, tipo) {
            selectedItem = { id, nome, codigo, tipo };
            document.getElementById('selectedItemId').value = id;
            document.getElementById('selectedItemName').value = nome;

            document.getElementById('selectedItemContainer').innerHTML = `
                <div class="selected-item">
                    <div class="selected-item-info">
                        <div class="selected-item-name">${escapeHtml(nome)}</div>
                        <div class="selected-item-code">C√≥digo: ${escapeHtml(codigo)} (${escapeHtml(tipo)})</div>
                    </div>
                    <button type="button" class="remove-item-btn" onclick="removeSelectedItem()">√ó</button>
                </div>
            `;

            document.getElementById('itemSearch').value = '';
            hideSearchResults();
        }

        function removeSelectedItem() {
            selectedItem = null;
            document.getElementById('selectedItemId').value = '';
            document.getElementById('selectedItemName').value = '';
            document.getElementById('selectedItemContainer').innerHTML = '';
        }

        function hideSearchResults() {
            document.getElementById('searchResults').style.display = 'none';
        }

        function adjustQuantity(delta) {
            const input = document.getElementById('quantityInput');
            const value = parseInt(input.value) || 1;
            input.value = Math.max(1, Math.min(9999, value + delta));
            validateQuantity();
        }

        function validateQuantity() {
            const input = document.getElementById('quantityInput');
            const value = parseInt(input.value);
            if (isNaN(value) || value < 1) input.value = 1;
            else if (value > 9999) input.value = 9999;
        }

        function showSuccessDialog() {
            const dialog = document.getElementById('successDialog');
            dialog.style.display = 'flex';
        }

        function hideSuccessDialog() {
            const dialog = document.getElementById('successDialog');
            dialog.style.display = 'none';
        }

        function newRequest() {
            const form = document.getElementById('solicitacaoForm');
            form.reset();
            removeSelectedItem();
            document.querySelectorAll('input[name="urgencia"]').forEach(radio => radio.checked = false);
            hideSuccessDialog();
        }

        function submitForm() {
            if (!selectedItem) {
                showNotification('Selecione um item.', true);
                return;
            }

            const form = document.getElementById('solicitacaoForm');
            const submitBtn = form.querySelector('.btn-primary');
            const btnText = submitBtn.querySelector('.btn-text');
            btnText.innerHTML = '<span class="loading"></span>Enviando...';
            submitBtn.disabled = true;

            const formData = new FormData(form);
            const solicitationData = {
                item_id: formData.get('item_id'),
                nome: formData.get('nome'),
                operador: formData.get('operador'),
                maquina: formData.get('maquina'),
                quantidade: parseInt(formData.get('quantidade')),
                urgencia: formData.get('urgencia'),
                justificativa: formData.get('justificativa'),
                tipo: selectedItem.tipo,
                data: new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' }),
                status: 'Pendente',
                visualizada: false
            };

            fetch('/solicitar_insumo', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || `HTTP ${response.status}`); });
                    }
                    return response.json();
                })
                .then(data => {
                    solicitationData.id = data.id;
                    socket.emit('new_solicitation', solicitationData);
                    console.log('üì¨ Solicita√ß√£o enviada via WebSocket:', solicitationData);
                    showNotification('Solicita√ß√£o enviada com sucesso! Redirecionando para a gest√£o...', false);
                    setTimeout(() => {
                        window.location.href = '/gestao';
                    }, 1200);
                })
                .catch(error => {
                    console.error('‚ùå Erro ao enviar solicita√ß√£o:', error);
                    showNotification(`Erro ao enviar: ${error.message}`, true);
                })
                .finally(() => {
                    btnText.innerHTML = 'Enviar';
                    submitBtn.disabled = false;
                });
        }

        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = `notification ${isError ? 'error' : 'success'}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 500);
            }, 4000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function goBack() {
            // Navega para a p√°gina anterior no hist√≥rico
            window.history.back();
        }
    </script>
    <script>
        // Override: avoid redirect to gestao; show success dialog instead
        (function(){
            window.submitForm = function(){
                if (!selectedItem) {
                    showNotification('Selecione um item.', true);
                    return;
                }
                const form = document.getElementById('solicitacaoForm');
                const submitBtn = form.querySelector('.btn-primary');
                const btnText = submitBtn.querySelector('.btn-text');
                btnText.innerHTML = '<span class="loading"></span>Enviando...';
                submitBtn.disabled = true;

                const formData = new FormData(form);
                const solicitationData = {
                    item_id: formData.get('item_id'),
                    nome: formData.get('nome'),
                    operador: formData.get('operador'),
                    maquina: formData.get('maquina'),
                    quantidade: parseInt(formData.get('quantidade')),
                    urgencia: formData.get('urgencia'),
                    justificativa: formData.get('justificativa'),
                    tipo: selectedItem ? selectedItem.tipo : '',
                    data: new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' }),
                    status: 'Pendente',
                    visualizada: false
                };

                fetch('/solicitar_insumo', {
                    method: 'POST',
                    headers: { 'Accept': 'application/json' },
                    body: formData
                })
                .then(async (response) => {
                    if (!response.ok) {
                        const ct = response.headers.get('content-type') || '';
                        if (ct.includes('application/json')) {
                            const err = await response.json().catch(() => ({}));
                            throw new Error(err.error || `HTTP ${response.status}`);
                        } else {
                            await response.text().catch(() => '');
                            throw new Error(`HTTP ${response.status}`);
                        }
                    }
                    const ct = response.headers.get('content-type') || '';
                    if (ct.includes('application/json')) {
                        return response.json();
                    }
                    return {};
                })
                .then((data) => {
                    if (data && data.id) solicitationData.id = data.id;
                    if (window.socket) {
                        window.socket.emit('new_solicitation', solicitationData);
                    }
                    showSuccessDialog();
                })
                .catch((error) => {
                    console.error('Erro ao enviar solicitacao:', error);
                    showNotification(`Erro ao enviar: ${error.message}`, true);
                })
                .finally(() => {
                    btnText.innerHTML = 'Enviar';
                    submitBtn.disabled = false;
                });
            };

            // Back to menu instead of history/gestao
            window.goBack = function(){ window.location.href = '/'; };
        })();
    </script>
</body>
</html>
