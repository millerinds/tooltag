ï»¿<!DOCTYPE html>

<html lang="pt-BR">

<head>

    <meta charset="UTF-8">

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Itens Atendidos - Gestão App</title>

    <style>

        /* Existing styles unchanged */

        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

        }



        body {

            font-family: 'Segoe UI', 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', Tahoma, Geneva, Verdana, sans-serif;

            background: linear-gradient(135deg, #e8e8e8 0%, #f5f5f5 100%);

            min-height: 100vh;

            padding: 20px;

        }



        .container {

            max-width: 1400px;

            margin: 0 auto;

            background: white;

            border-radius: 20px;

            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);

            overflow: hidden;

        }



        .header {

            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);

            color: white;

            padding: 30px;

            text-align: center;

            position: relative;

        }



        .header h1 {

            font-size: 28px;

            font-weight: bold;

            margin-bottom: 10px;

            text-transform: uppercase;

            letter-spacing: 1px;

        }



        .header p {

            font-size: 16px;

            opacity: 0.9;

        }



        .content {

            padding: 30px;

        }



        .filters {

            background: #f8f9fa;

            border-radius: 15px;

            padding: 20px;

            margin-bottom: 30px;

            display: flex;

            gap: 15px;

            flex-wrap: wrap;

            align-items: center;

        }



        .filter-group {

            display: flex;

            flex-direction: column;

            gap: 5px;

        }



        .filter-group label {

            font-weight: bold;

            color: #2c3e50;

            font-size: 12px;

            text-transform: uppercase;

        }



        .filter-group input,

        .filter-group select {

            padding: 8px 12px;

            border: 1px solid #bdc3c7;

            border-radius: 8px;

            font-size: 14px;

            min-width: 150px;

        }



        .date-range {

            display: flex;

            align-items: center;

            gap: 8px;

        }



        .date-range span {

            font-size: 12px;

            font-weight: 600;

            color: #2c3e50;

        }



        .date-range input {

            min-width: 0;

        }



        .stats {

            display: grid;

            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));

            gap: 20px;

            margin-bottom: 30px;

        }



        .stat-card {

            background: linear-gradient(135deg, #3498db, #2980b9);

            color: white;

            padding: 20px;

            border-radius: 15px;

            text-align: center;

        }



        .stat-card h3 {

            font-size: 24px;

            margin-bottom: 5px;

        }



        .stat-card p {

            font-size: 14px;

            opacity: 0.9;

        }



        .atendidos-grid {

            display: grid;

            gap: 20px;

        }



        .atendido-card {

            background: white;

            border: 2px solid #ecf0f1;

            border-radius: 15px;

            overflow: hidden;

            transition: all 0.3s ease;

        }



        .atendido-card:hover {

            transform: translateY(-2px);

            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);

        }



        .atendido-header {

            background: #27ae60;

            color: white;

            padding: 15px 20px;

            display: flex;

            justify-content: space-between;

            align-items: center;

        }



        .atendido-id {

            font-weight: bold;

            font-size: 16px;

        }



        .atendido-date {

            font-size: 14px;

            opacity: 0.9;

        }



        .atendido-content {

            padding: 20px;

        }



        .atendido-info {

            display: grid;

            grid-template-columns: 1fr 1fr;

            gap: 15px;

            margin-bottom: 15px;

        }



        .info-item {

            display: flex;

            flex-direction: column;

            gap: 5px;

        }



        .info-label {

            font-weight: bold;

            color: #7f8c8d;

            font-size: 12px;

            text-transform: uppercase;

            letter-spacing: 0.5px;

        }



        .info-value {

            color: #2c3e50;

            font-size: 14px;

            padding: 8px 12px;

            background: #f8f9fa;

            border-radius: 6px;

            border: 1px solid #e9ecef;

        }



        .info-value.editable {

            border: 1px solid #3498db;

            outline: none;

            cursor: text;

        }



        .info-value.editable:focus {

            background: white;

            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);

        }



        .prioridade {

            display: inline-block;

            padding: 4px 8px;

            border-radius: 12px;

            font-size: 11px;

            font-weight: bold;

            text-transform: uppercase;

        }



        .prioridade.baixa {

            background: rgba(39, 174, 96, 0.1);

            color: #27ae60;

            border: 1px solid #27ae60;

        }



        .prioridade.media {

            background: rgba(243, 156, 18, 0.1);

            color: #f39c12;

            border: 1px solid #f39c12;

        }



        .prioridade.alta {

            background: rgba(231, 76, 60, 0.1);

            color: #e74c3c;

            border: 1px solid #e74c3c;

        }



        .prioridade.critica {

            background: rgba(142, 68, 173, 0.1);

            color: #8e44ad;

            border: 1px solid #8e44ad;

        }



        .prioridade.Urgênte {

            background: rgba(255, 99, 71, 0.1);

            color: #ff6347;

            border: 1px solid #ff6347;

        }



        .tipo {

            display: inline-block;

            padding: 4px 8px;

            border-radius: 12px;

            font-size: 11px;

            font-weight: bold;

            text-transform: uppercase;

            background: rgba(52, 152, 219, 0.1);

            color: #3498db;

            border: 1px solid #3498db;

        }



        .atendido-description {

            margin: 15px 0;

        }



        .description-content {

            background: #f8f9fa;

            padding: 15px;

            border-radius: 8px;

            border-left: 4px solid #27ae60;

            font-size: 14px;

            line-height: 1.5;

            min-height: 40px;

        }



        .description-content.editable {

            border: 1px solid #3498db;

            outline: none;

            cursor: text;

            resize: vertical;

        }



        .atendimento-info {

            background: #e8f5e8;

            border: 1px solid #27ae60;

            border-radius: 10px;

            padding: 15px;

            margin-top: 15px;

        }



        .atendimento-header {

            display: flex;

            justify-content: space-between;

            align-items: center;

            margin-bottom: 10px;

        }



        .atendimento-title {

            color: #27ae60;

            font-weight: bold;

            font-size: 14px;

        }



        .atendimento-date {

            color: #27ae60;

            font-size: 12px;

        }



        .atendimento-details {

            display: grid;

            grid-template-columns: 1fr 2fr;

            gap: 15px;

        }



        .observacoes {

            grid-column: 1 / -1;

            margin-top: 10px;

        }



        .observacoes-content {

            background: white;

            padding: 10px;

            border-radius: 6px;

            font-size: 14px;

            line-height: 1.4;

            min-height: 30px;

            border: 1px solid #d5e7d5;

        }



        .observacoes-content.editable {

            border: 1px solid #3498db;

            outline: none;

            cursor: text;

            resize: vertical;

        }



        /* Fotos do Atendimento (upload) */

        .photo-upload {

            border: 2px dashed #d1d5db;

            background: #fafafa;

            padding: 14px;

            border-radius: 10px;

            text-align: center;

            margin-top: 8px;

            transition: all 0.2s ease;

        }

        .photo-upload.dragover { border-color: #3498db; background: #ecf5fd; }

        .photo-upload.disabled { opacity: 0.6; pointer-events: none; }

        .file-button {

            margin-top: 8px;

            padding: 8px 12px;

            background: #3498db;

            color: white;

            border: none;

            border-radius: 8px;

            cursor: pointer;

            font-weight: 600;

        }

        .file-input { display: none; }

        .checkbox-group { display: flex; align-items: center; gap: 8px; margin-top: 8px; }

        .photo-preview { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 10px; }

        .photo-item { position: relative; border: 1px solid #e1e8ed; border-radius: 8px; overflow: hidden; }

        .photo-item img { width: 100%; height: 80px; object-fit: cover; display: block; }

        .photo-remove { position: absolute; top: 4px; right: 4px; border: none; background: rgba(231,76,60,0.9); color: #fff; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; line-height: 22px; font-weight: bold; }



        .card-actions {

            padding: 15px 20px;

            background: #f8f9fa;

            border-top: 1px solid #e9ecef;

            display: flex;

            gap: 10px;

            justify-content: flex-end;

        }



        .btn {

            padding: 8px 16px;

            border: none;

            border-radius: 6px;

            font-size: 12px;

            font-weight: bold;

            text-transform: uppercase;

            cursor: pointer;

            transition: all 0.3s ease;

            display: inline-flex;

            align-items: center;

            gap: 5px;

        }



        .btn-edit {

            background: #3498db;

            color: white;

        }



        .btn-edit:hover {

            background: #2980b9;

        }



        .btn-save {

            background: #27ae60;

            color: white;

        }



        .btn-save:hover {

            background: #219a52;

        }



        .btn-cancel {

            background: #95a5a6;

            color: white;

        }



        .btn-cancel:hover {

            background: #7f8c8d;

        }



        .btn-back {

            background: #34495e;

            color: white;

            padding: 12px 25px;

            text-decoration: none;

            display: inline-block;

            margin-bottom: 20px;

        }



        .btn-back:hover {

            background: #2c3e50;

        }



        .editing {

            border-color: #3498db !important;

            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);

        }



        .no-atendidos {

            text-align: center;

            padding: 60px 20px;

            color: #7f8c8d;

        }



        .no-atendidos h3 {

            font-size: 24px;

            margin-bottom: 15px;

        }



        .no-atendidos p {

            font-size: 16px;

        }



        .notification {

            position: fixed;

            top: 20px;

            right: 20px;

            padding: 15px 25px;

            border-radius: 10px;

            color: white;

            font-weight: bold;

            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);

            z-index: 1000;

            opacity: 0;

            transform: translateX(100%);

            transition: all 0.3s ease;

        }



        .notification.show {

            opacity: 1;

            transform: translateX(0);

        }



        .notification.success {

            background: #27ae60;

        }



        .notification.error {

            background: #e74c3c;

        }



        .loading {

            text-align: center;

            padding: 50px;

            color: #7f8c8d;

        }



        .loading::after {

            content: '';

            display: inline-block;

            width: 20px;

            height: 20px;

            border: 3px solid #3498db;

            border-radius: 50%;

            border-top-color: transparent;

            animation: spin 1s ease-in-out infinite;

            margin-left: 10px;

        }



        @keyframes spin {

            to { transform: rotate(360deg); }

        }



        @media (max-width: 768px) {

            body {

                padding: 10px;

            }



            .content {

                padding: 15px;

            }



            .filters {

                flex-direction: column;

                align-items: stretch;

            }



            .filter-group {

                width: 100%;

            }



            .atendido-info {

                grid-template-columns: 1fr;

            }



            .atendimento-details {

                grid-template-columns: 1fr;

            }



            .stats {

                grid-template-columns: 1fr;

            }



            .card-actions {

                flex-direction: column;

            }



            .btn {

                width: 100%;

                justify-content: center;

            }

        }



        .filter-group input[type="text"],

        .filter-group select {

            transition: border-color 0.3s ease;

        }



        .filter-group input[type="text"]:focus,

        .filter-group select:focus {

            border-color: #3498db;

            outline: none;

            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);

        }



        .hidden {

            display: none !important;

        }



        /* Lightbox (fullscreen image) */

        .lightbox-overlay {

            position: fixed;

            inset: 0;

            background: rgba(0, 0, 0, 0.92);

            display: none;

            align-items: center;

            justify-content: center;

            z-index: 9999;

        }

        .lightbox-overlay.show { display: flex; }

        .lightbox-content { position: relative; max-width: 95vw; max-height: 95vh; }

        .lightbox-img {

            max-width: 95vw;

            max-height: 95vh;

            object-fit: contain;

            border-radius: 8px;

            box-shadow: 0 10px 40px rgba(0,0,0,0.6);

        }

        .lightbox-actions {

            position: absolute;

            top: 12px;

            right: 12px;

            display: flex;

            gap: 8px;

        }

        .lightbox-actions .btn {

            padding: 8px 12px;

            font-size: 13px;

            border-radius: 8px;

            border: none;

            cursor: pointer;

        }

        .btn-download { background: #2ecc71; color: #fff; }

        .btn-close { background: #e74c3c; color: #fff; }

        /* Indicate click-to-zoom on thumbnails (only when we add class zoomable) */

        .photo-item img { cursor: default; }

        img.zoomable { cursor: zoom-in; }



        /* Attached photos gallery */

        .attached-photos-block { display: block; }

        .attached-photos.photo-preview { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); }

        .attached-photos .photo-item img { cursor: default; }



        /* Allow adding photos only in edit mode */

        .atendido-card .upload-block { display: none; }

        .atendido-card.editing .upload-block { display: block; }



        /* Delete button for persisted photos (only in edit mode) */

        .photo-delete { position: absolute; top: 4px; right: 4px; border: none; background: rgba(231,76,60,0.95); color: #fff; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; line-height: 22px; font-weight: bold; display: none; }

        .atendido-card.editing .photo-delete { display: inline-block; }

    </style>

</head>

<body>

    <div class="container">

        <div class="header">

            <h1>Itens Atendidos</h1>

            <p>Histórico completo de insumos e ocorrências resolvidos</p>

        </div>



        <div class="content">

            <button type="button" class="btn btn-back" onclick="goBack()">Voltar</button>



            <div class="stats" id="stats">

                <div class="stat-card">

                    <h3 id="totalAtendidos">0</h3>

                    <p>Total de Itens Atendidos</p>

                </div>

                <div class="stat-card">

                    <h3 id="atendidosHoje">0</h3>

                    <p>Atendidos Hoje</p>

                </div>

                <div class="stat-card">

                    <h3 id="atendidosSemana">0</h3>

                    <p>Esta Semana</p>

                </div>

                <div class="stat-card">

                    <h3 id="atendidosMes">0</h3>

                    <p>Este Mês</p>

                </div>

            </div>



            <div class="filters">
                <div class="filter-group">
                    <label>Buscar por Nome/Item cadastrado</label>
                    <input type="text" id="filterTitulo" placeholder="Digite o nome, item ou ID interno...">
                </div>

                <div class="filter-group">
                    <label>Prioridade</label>
                    <select id="filterPrioridade">
                        <option value="">Todas as prioridades</option>
                        <option value="baixa">Baixa</option>
                        <option value="media">Média</option>
                        <option value="alta">Alta</option>
                        <option value="critica">Crítica</option>
                        <option value="urgente">Urgente</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Atendida por</label>
                    <input type="text" id="filterAtendidaPor" placeholder="Nome do atendente...">
                </div>

                <div class="filter-group">
                    <label>Data de Atendimento</label>
                    <div class="date-range">
                        <input type="date" id="filterDataInicio">
                        <span>até</span>
                        <input type="date" id="filterDataFim">
                    </div>
                </div>

                <div class="filter-group">
                    <label>Relatórios</label>
                    <button class="btn btn-edit" onclick="generateReport()">Gerar Relatório PDF</button>
                </div>
            </div>
            <div id="atendidosContainer">

                <div class="loading">Carregando itens atendidos...</div>

            </div>

        </div>

    </div>



    <div class="notification" id="notification"></div>



    <script>

        let atendidosData = [];

        let editingCard = null;



        document.addEventListener('DOMContentLoaded', function() {

            loadAtendidos();

            setupEventListeners();

        });



        function setupEventListeners() {

            document.getElementById('filterTitulo').addEventListener('input', applyFilters);

            

            document.getElementById('filterPrioridade').addEventListener('change', applyFilters);

            document.getElementById('filterAtendidaPor').addEventListener('input', applyFilters);

            document.getElementById('filterDataInicio').addEventListener('change', applyFilters);

            document.getElementById('filterDataFim').addEventListener('change', applyFilters);

        }



        function loadAtendidos() {

            fetch('/api/atendidos')

                .then(response => {

                    if (!response.ok) {

                        throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);

                    }

                    return response.json();

                })

                .then(data => {

                    atendidosData = data;

                    updateStats();

                    populateFilters();

                    renderAtendidos(data);

                })

                .catch(error => {

                    console.error('Erro ao carregar itens atendidos:', error);

                    showNotification(`Erro ao carregar dados: ${error.message}`, 'error');

                    document.getElementById('atendidosContainer').innerHTML = `

                        <div class="no-atendidos">

                            <h3>Erro ao carregar</h3>

                            <p>${error.message}</p>

                        </div>

                    `;

                });

        }



        function updateStats() {

            const hoje = new Date().toDateString();

            const semanaAtras = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);

            const mesAtras = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);



            let atendidosHoje = 0;

            let atendidosSemana = 0;

            let atendidosMes = 0;



            atendidosData.forEach(item => {

                if (item.data_atendimento) {

                    const dataAtendimento = parseDate(item.data_atendimento);

                    if (dataAtendimento && dataAtendimento.toDateString() === hoje) {

                        atendidosHoje++;

                    }

                    if (dataAtendimento && dataAtendimento >= semanaAtras) {

                        atendidosSemana++;

                    }

                    if (dataAtendimento && dataAtendimento >= mesAtras) {

                        atendidosMes++;

                    }

                }

            });



            document.getElementById('totalAtendidos').textContent = atendidosData.length;

            document.getElementById('atendidosHoje').textContent = atendidosHoje;

            document.getElementById('atendidosSemana').textContent = atendidosSemana;

            document.getElementById('atendidosMes').textContent = atendidosMes;

        }



        function populateFilters() {

            // Tipo removido; sem opções dinÃÂ¢micas necessárias

        }



        function generateReport() {

            try {

                const titulo = encodeURIComponent(document.getElementById('filterTitulo').value || '');

                const prioridade = encodeURIComponent(document.getElementById('filterPrioridade').value || '');

                const atendidaPor = encodeURIComponent(document.getElementById('filterAtendidaPor').value || '');

                const url = `/relatorio/ocorrencias?titulo=${titulo}&prioridade=${prioridade}&atendida_por=${atendidaPor}`;

                window.open(url, '_blank');

            } catch (e) {

                console.error('Erro ao gerar relatório:', e);

                showNotification('Erro ao gerar relatório.', 'error');

            }

        }



        function renderAtendidos(data) {

            const container = document.getElementById('atendidosContainer');

            

            if (!data || data.length === 0) {

                container.innerHTML = `

                    <div class="no-atendidos">

                        <h3>Nenhum item atendido</h3>

                        <p>Não há itens atendidos para exibir.</p>

                    </div>

                `;

                return;

            }



            const html = data.map(item => createAtendidoCard(item)).join('');

            container.innerHTML = `<div class="atendidos-grid">${html}</div>`;

            try { addMachineBlocks(); } catch (e) { console.warn('addMachineBlocks failed', e); }

        }



        function addMachineBlocks() {

            try {

                const cards = document.querySelectorAll('.atendido-card[data-source="insumo"]');

                cards.forEach(card => {

                    if (card.querySelector('.info-item.info-maquina')) return;

                    const infoGrid = card.querySelector('.atendido-info');

                    if (!infoGrid) return;

                    // Renomeia o rótulo inicial de 'Nome' para 'Solicitante'

                    const firstLabel = infoGrid.querySelector('.info-item .info-label');

                    if (firstLabel && (firstLabel.textContent || '').trim().toLowerCase() === 'nome') {

                        firstLabel.textContent = 'Solicitante';

                    }

                    const id = parseInt(card.dataset.id || '0', 10);

                    const data = atendidosData.find(o => o.id === id && o.source === 'insumo') || {};

                    const machine = data.maquina || '';

                    const block = document.createElement('div');

                    block.className = 'info-item info-maquina';

                    block.innerHTML = '<div class="info-label">Máquina</div>' +

                                      `<div class="info-value">${machine || 'Nao informada'}</div>`;

                    const itemCadastrado = Array.from(infoGrid.children).find(el =>

                        el.querySelector && el.querySelector('.info-label') && (el.querySelector('.info-label').textContent || '').trim().toLowerCase().includes('item cadastrado')

                    );

                    if (itemCadastrado) {

                        infoGrid.insertBefore(block, itemCadastrado);

                    } else {

                        infoGrid.appendChild(block);

                    }

                });

            } catch (e) {

                console.warn('Falha ao inserir bloco de Maquina:', e);

            }

        }



        function createAtendidoCard(item) {

            const prioridadeClass = (item.prioridade || 'baixa').toLowerCase();

            const idDisplay = item.source === 'insumo' ? (item.codigo_interno || item.id) : (item.ocorrencia_id || item.id);

            

            return `

                <div class="atendido-card" data-id="${item.id}" data-source="${item.source}">

                    <div class="atendido-header">

                        <div class="atendido-id">${item.source === 'insumo' ? 'Insumo' : (item.source.charAt(0).toUpperCase() + item.source.slice(1))} #${idDisplay}</div>

                        <div class="atendido-date">${item.data_atendimento || 'Data não informada'}</div>

                    </div>

                    

                    <div class="atendido-content">

                        <div class="atendido-info">

                            <div class="info-item">

                                <div class="info-label">${item.source === 'insumo' ? 'Nome' : 'Título'}</div>

                                <div class="info-value" data-field="titulo">${item.titulo || 'Não informado'}</div>

                            </div>

                            <div class="info-item">

                                <div class="info-label">Tipo</div>

                                <div class="info-value">

                                    <span class="tipo">${item.tipo || 'Não informado'}</span>

                                </div>

                            </div>

                            <div class="info-item">

                                <div class="info-label">Prioridade</div>

                                <div class="info-value">

                                    <span class="prioridade ${prioridadeClass}">${item.prioridade || 'Não informada'}</span>

                                </div>

                            </div>

                            <div class="info-item">

                                <div class="info-label">Data da Solicitação</div>

                                <div class="info-value">${item.data_original || 'Não informada'}</div>

                            </div>

                            ${item.source === 'insumo' ? `

                            <div class="info-item">

                                <div class="info-label">Item Cadastrado</div>

                                <div class="info-value">${item.nome_item || 'Não informado'}</div>

                            </div>

                            ` : ''}

                        </div>



                        <div class="atendido-description">

                            <div class="info-label">${item.source === 'insumo' ? 'Justificativa' : 'Descrição'}</div>

                            <div class="description-content" data-field="descricao">${item.descricao || 'Nenhuma descrição fornecida'}</div>

                        </div>



                        <div class="atendimento-info">

                            <div class="atendimento-header">

                                <div class="atendimento-title">Informações do Atendimento</div>

                                <div class="atendimento-date">${item.data_atendimento || 'Data não informada'}</div>

                            </div>

                            

                            <div class="atendimento-details">

                                <div class="info-item">

                                    <div class="info-label">Atendida por</div>

                                    <div class="info-value" data-field="atendida_por">${item.atendida_por || 'Não informado'}</div>

                                </div>

                                <div class="info-item">

                                    <div class="info-label">Status Original</div>

                                    <div class="info-value">${item.status_original || 'Não informado'}</div>

                                </div>

                                <div class="observacoes">

                                    <div class="info-label">Observações do Atendimento</div>

                                    <div class="observacoes-content" data-field="observacoes_atendimento">${item.observacoes_atendimento || 'Nenhuma observação'}</div>

                                </div>

                                ${item.source === 'insumo' && item.fotos && item.fotos.length ? `

                                <div class="info-item attached-photos-block" style="grid-column: 1 / -1;">

                                    <div class="info-label">Fotos Anexadas</div>

                                    <div class="photo-preview attached-photos">

                                        ${ (item.fotos || []).map(fn => `<div class=\"photo-item\"><img class=\"zoomable\" src=\"/fotos_insumos/${fn}\" alt=\"Foto\"><button type=\"button\" class=\"photo-delete\" onclick=\"deletePersistedPhoto(${item.id}, '${'${fn}'.replace(/'/g, "\\'")}')\">&times;</button></div>`).join('') }

                                    </div>

                                </div>

                                ` : ''}

                                ${item.source === 'insumo' ? `

                                <div class="info-item upload-block" style="grid-column: 1 / -1;">

                                    <div class="info-label">Fotos do Atendimento</div>

                                    <div class="photo-upload" id="photoUpload-${item.id}">

                                        <p>Clique para selecionar ou arraste as fotos aqui</p>

                                        <button type="button" class="file-button" onclick="document.getElementById('photoInput-${item.id}').click()">Selecionar Fotos</button>

                                        <input type="file" id="photoInput-${item.id}" class="file-input" accept="image/*" multiple onchange="handleFileSelectAtendido(${item.id}, event)">

                                    </div>

                                    <div class="checkbox-group">

                                        <input type="checkbox" id="semFotos-${item.id}" onchange="togglePhotoRequirementAtendido(${item.id})">

                                        <label for="semFotos-${item.id}">Não foi possível tirar fotos (marque apenas se necessário)</label>

                                    </div>

                                    <div class="photo-preview" id="photoPreview-${item.id}"></div>

                                </div>

                                ` : ''}

                            </div>

                        </div>

                    </div>



                        <div class="card-actions">

                            <button class="btn btn-edit" onclick="editAtendido(${item.id}, '${item.source}')">Editar</button>

                            <button class="btn btn-save hidden" onclick="saveAtendido(${item.id}, '${item.source}')">Salvar</button>

                            <button class="btn btn-cancel hidden" onclick="cancelEdit(${item.id})">Cancelar</button>

                            <button class="btn btn-delete" onclick="reabrirAtendido(${item.id}, '${item.source}')">Marcar como Não Atendida</button>

                        </div>

                    </div>

            `;

        }



        let selectedFilesMap = {};

        let autoSaving = false;



        function editAtendido(id, source) {

            if (editingCard && editingCard !== id) {

                cancelEdit(editingCard);

            }



            editingCard = id;

            const card = document.querySelector(`[data-id="${id}"]`);

            card.classList.add('editing');



            const editableFields = ['titulo', 'descricao', 'atendida_por', 'observacoes_atendimento'];

            editableFields.forEach(field => {

                const element = card.querySelector(`[data-field="${field}"]`);

                if (element) {

                    element.contentEditable = true;

                    element.classList.add('editable');

                }

            });



            card.querySelector('.btn-edit').classList.add('hidden');

            card.querySelector('.btn-save').classList.remove('hidden');

            card.querySelector('.btn-cancel').classList.remove('hidden');



            showNotification('Modo de edição ativado. Clique nos campos para editar.', 'success');



            // Inicializar upload de fotos somente para insumo

            if (source === 'insumo') {

                selectedFilesMap[id] = selectedFilesMap[id] || [];

                const card = document.querySelector(`[data-id="${id}"]`);

                const upload = card.querySelector(`#photoUpload-${id}`);

                const input = card.querySelector(`#photoInput-${id}`);

                const preview = card.querySelector(`#photoPreview-${id}`);

                if (upload && input && preview) {

                    upload.addEventListener('dragover', function(e){ e.preventDefault(); upload.classList.add('dragover'); });

                    upload.addEventListener('dragleave', function(e){ e.preventDefault(); upload.classList.remove('dragover'); });

                    upload.addEventListener('drop', function(e){ e.preventDefault(); upload.classList.remove('dragover'); const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/')); addFilesAtendido(id, files); try { autoSaving = true; saveAtendido(id, 'insumo'); } catch (err) { console.error('Auto-save drop falhou:', err); autoSaving = false; } });

                }

                updateSemFotosState(id);

            }

        }



        function cancelEdit(id) {

            const card = document.querySelector(`[data-id="${id}"]`);

            card.classList.remove('editing');



            const originalData = atendidosData.find(o => o.id === id);

            if (originalData) {

                card.querySelector('[data-field="titulo"]').textContent = originalData.titulo || 'Não informado';

                card.querySelector('[data-field="descricao"]').textContent = originalData.descricao || 'Nenhuma descrição fornecida';

                card.querySelector('[data-field="atendida_por"]').textContent = originalData.atendida_por || 'Não informado';

                card.querySelector('[data-field="observacoes_atendimento"]').textContent = originalData.observacoes_atendimento || 'Nenhuma observação';

            }



            const editableFields = card.querySelectorAll('.editable');

            editableFields.forEach(element => {

                element.contentEditable = false;

                element.classList.remove('editable');

            });



            card.querySelector('.btn-edit').classList.remove('hidden');

            card.querySelector('.btn-save').classList.add('hidden');

            card.querySelector('.btn-cancel').classList.add('hidden');



            editingCard = null;

        }



        function saveAtendido(id, source) {

            const card = document.querySelector(`[data-id="${id}"]`);

            

            const updatedData = {

                titulo: card.querySelector('[data-field="titulo"]').textContent.trim(),

                descricao: card.querySelector('[data-field="descricao"]').textContent.trim(),

                atendida_por: card.querySelector('[data-field="atendida_por"]').textContent.trim(),

                observacoes_atendimento: card.querySelector('[data-field="observacoes_atendimento"]').textContent.trim()

            };



            if (!updatedData.titulo || !updatedData.atendida_por) {

                showNotification('Título/Nome e "Atendida por" são campos obrigatórios', 'error');

                return;

            }



            const formData = new FormData();

            Object.keys(updatedData).forEach(key => {

                formData.append(key, updatedData[key]);

            });



            if (source === 'insumo') {

                // Garantir status Atendido e anexar fotos/sem_fotos

                formData.append('status', 'Atendido');

                const semFotosEl = document.getElementById(`semFotos-${id}`);

                const semFotos = semFotosEl ? semFotosEl.checked : false;

                formData.append('sem_fotos', semFotos);

                const files = selectedFilesMap[id] || [];

                files.forEach((file, index) => formData.append(`foto_${index}`, file));

            }



            const endpoint = source === 'insumo' ? `/api/insumo/${id}/atender` : `/api/ocorrencia_atendida/${id}`;

            fetch(endpoint, {

                method: 'PUT',

                body: formData

            })

            .then(response => {

                if (!response.ok) {

                    return response.json().then(err => { throw new Error(err.error || `HTTP ${response.status}`); });

                }

                return response.json();

            })

            .then(data => {

                showNotification('Item atualizado com sucesso!', 'success');

                

                const index = atendidosData.findIndex(o => o.id === id);

                if (index !== -1) {

                    Object.assign(atendidosData[index], updatedData);

                    if (data && data.fotos) {

                        atendidosData[index].fotos = data.fotos;

                        atendidosData[index].fotos_urls = data.fotos_urls || (data.fotos || []).map(fn => `/fotos_insumos/${fn}`);

                    }

                }

                

                if (source === 'insumo') {

                    // Limpar seleção de fotos do card

                    selectedFilesMap[id] = [];

                }

                if (autoSaving) {

                    const _src = source;

                    renderAtendidos(atendidosData);

                    setTimeout(() => { try { editAtendido(id, _src); } catch (e) {} autoSaving = false; }, 0);

                } else {

                    cancelEdit(id);

                    renderAtendidos(atendidosData);

                }

            })

            .catch(error => {

                console.error('Erro ao salvar:', error);

                showNotification(`Erro ao salvar: ${error.message}`, 'error');

            });

        }



        function reabrirAtendido(id, source) {

            try {

                const proceed = confirm('Confirmar: marcar como NãO atendida e remover da lista?');

                if (!proceed) return;

                const endpoint = source === 'insumo' ? `/api/insumo/${id}/reabrir` : `/api/ocorrencia/${id}/reabrir`;

                fetch(endpoint, { method: 'PUT' })

                    .then(response => {

                        if (!response.ok) {

                            return response.json().then(err => { throw new Error(err.error || `HTTP ${response.status}`); });

                        }

                        return response.json();

                    })

                    .then(() => {

                        showNotification('Item marcado como não atendido.', 'success');

                        // Remove do array e re-renderiza

                        atendidosData = atendidosData.filter(o => !(o.id === id && o.source === source));

                        renderAtendidos(atendidosData);

                    })

                    .catch(err => {

                        console.error('Erro ao reabrir:', err);

                        showNotification(`Erro ao reabrir: ${err.message}`, 'error');

                    });

            } catch (e) {

                console.error('Erro ao reabrir:', e);

                showNotification('Erro ao reabrir item.', 'error');

            }

        }



        function handleFileSelectAtendido(id, event) {

            const files = Array.from(event.target.files || []);

            addFilesAtendido(id, files);

            try { autoSaving = true; saveAtendido(id, 'insumo'); } catch (e) { console.error('Auto-save falhou:', e); autoSaving = false; }

            event.target.value = '';

        }



        function addFilesAtendido(id, files) {

            const card = document.querySelector(`[data-id="${id}"]`);

            if (!card || !card.classList.contains('editing')) {

                showNotification('Ative a edição para anexar fotos.', 'error');

                return;

            }

            if (!selectedFilesMap[id]) selectedFilesMap[id] = [];

            files.forEach(file => {

                if (file.type.startsWith('image/') && file.size <= 16 * 1024 * 1024) {

                    selectedFilesMap[id].push(file);

                } else {

                    showNotification('Arquivo inválido ou muito grande (máx 16MB)', 'error');

                }

            });

            refreshPhotoPreviewAtendido(id);

            updateSemFotosState(id);

        }



        function refreshPhotoPreviewAtendido(id) {

            const preview = document.getElementById(`photoPreview-${id}`);

            if (!preview) return;

            preview.innerHTML = '';

            (selectedFilesMap[id] || []).forEach((file, index) => {

                const reader = new FileReader();

                reader.onload = function(e) {

                    const photoItem = document.createElement('div');

                    photoItem.className = 'photo-item';

                    photoItem.innerHTML = `<img src=\"${e.target.result}\" alt=\"Preview ${index+1}\"><button type=\"button\" class=\"photo-remove\" onclick=\"removePhotoAtendido(${id}, ${index})\">&times;</button>`;

                    preview.appendChild(photoItem);

                };

                reader.readAsDataURL(file);

            });

        }



        function removePhotoAtendido(id, index) {

            if (!selectedFilesMap[id]) return;

            selectedFilesMap[id].splice(index, 1);

            refreshPhotoPreviewAtendido(id);

            updateSemFotosState(id);

        }



        function togglePhotoRequirementAtendido(id) {

            const sem = !!document.getElementById(`semFotos-${id}`)?.checked;

            const upload = document.getElementById(`photoUpload-${id}`);

            const preview = document.getElementById(`photoPreview-${id}`);

            if (sem) {

                upload?.classList.add('disabled');

                selectedFilesMap[id] = [];

                if (preview) preview.innerHTML = '';

            } else {

                upload?.classList.remove('disabled');

            }

        }



        function updateSemFotosState(id) {

            const semEl = document.getElementById(`semFotos-${id}`);

            if (!semEl) return;

            const data = atendidosData.find(o => o.id === id) || {};

            const persisted = Array.isArray(data.fotos) ? data.fotos.length : 0;

            const selected = Array.isArray(selectedFilesMap[id]) ? selectedFilesMap[id].length : 0;

            const hasAny = (persisted + selected) > 0;

            if (hasAny) {

                semEl.checked = false;

                semEl.disabled = true;

            } else {

                semEl.disabled = false;

                semEl.checked = true;

            }

        }



        function applyFilters() {

            const query = (document.getElementById('filterTitulo').value || '').toLowerCase().trim();

            const prioridade = (document.getElementById('filterPrioridade').value || '').toLowerCase();

            const atendidaPor = (document.getElementById('filterAtendidaPor').value || '').toLowerCase();

            const dataInicioValue = document.getElementById('filterDataInicio').value;

            const dataFimValue = document.getElementById('filterDataFim').value;



            const dataInicio = dataInicioValue ? new Date(`${dataInicioValue}T00:00:00`) : null;

            const dataFim = dataFimValue ? new Date(`${dataFimValue}T23:59:59`) : null;



            const filteredData = atendidosData.filter(item => {

                const titulo = (item.titulo || '').toLowerCase();

                const nomeItem = (item.nome_item || '').toLowerCase();

                const codInterno = (item.codigo_interno !== undefined && item.codigo_interno !== null)

                    ? String(item.codigo_interno).toLowerCase()

                    : '';



                const nomeOuTituloMatch = !query || titulo.includes(query) || nomeItem.includes(query) || codInterno.includes(query);

                const prioridadeMatch = !prioridade || ((item.prioridade || '').toLowerCase() === prioridade);

                const atendidaMatch = !atendidaPor || ((item.atendida_por || '').toLowerCase().includes(atendidaPor));



                const dataReferencia = parseDate(item.data_atendimento || item.data_original || '');

                const dataMatch = (!dataInicio || (dataReferencia && dataReferencia >= dataInicio)) &&

                                  (!dataFim || (dataReferencia && dataReferencia <= dataFim));



                return nomeOuTituloMatch && prioridadeMatch && atendidaMatch && dataMatch;

            });



            renderAtendidos(filteredData);

        }



        function parseDate(dateString) {

            if (!dateString) return null;



            const trimmed = dateString.trim();

            if (!trimmed) return null;



            const parts = trimmed.split(' ');

            const datePart = parts[0];

            const dateParts = datePart.split('/');

            if (dateParts.length !== 3) return null;



            const day = parseInt(dateParts[0], 10);

            const month = parseInt(dateParts[1], 10) - 1;

            const year = parseInt(dateParts[2], 10);

            if (Number.isNaN(day) || Number.isNaN(month) || Number.isNaN(year)) return null;



            let hours = 0;

            let minutes = 0;

            let seconds = 0;

            if (parts.length > 1 && parts[1]) {

                const timeParts = parts[1].split(':');

                if (timeParts.length >= 2) {

                    hours = parseInt(timeParts[0], 10) || 0;

                    minutes = parseInt(timeParts[1], 10) || 0;

                    if (timeParts.length >= 3) {

                        seconds = parseInt(timeParts[2], 10) || 0;

                    }

                }

            }



            return new Date(year, month, day, hours, minutes, seconds);

        }



        function showNotification(message, type = 'success') {

            const notification = document.getElementById('notification');

            notification.textContent = message;

            notification.className = `notification ${type}`;

            notification.classList.add('show');

            

            setTimeout(() => {

                notification.classList.remove('show');

            }, 3000);

        }

        // Delete a persisted photo from an insumo

        function deletePersistedPhoto(id, name) {

            if (!name) return;

            const card = document.querySelector(`[data-id="${id}"]`);

            const wasEditing = card?.classList.contains('editing');

            fetch(`/api/insumo/${id}/foto?name=${encodeURIComponent(name)}`, { method: 'DELETE' })

                .then(resp => {

                    if (!resp.ok) return resp.json().then(err => { throw new Error(err.error || `HTTP ${resp.status}`); });

                    return resp.json();

                })

                .then(data => {

                    const index = atendidosData.findIndex(o => o.id === id);

                    if (index !== -1 && data && data.fotos) {

                        atendidosData[index].fotos = data.fotos;

                        atendidosData[index].fotos_urls = data.fotos_urls || (data.fotos || []).map(fn => `/fotos_insumos/${fn}`);

                    }

                    renderAtendidos(atendidosData);

                    showNotification('Foto removida.', 'success');

                })

                .catch(err => {

                    console.error('Erro ao remover foto:', err);

                    showNotification(`Erro ao remover foto: ${err.message}`, 'error');

                });

        }

        // Intercept delete photo clicks early (capture) to avoid other handlers

        document.addEventListener('click', function(e) {

            const del = e.target.closest('.photo-delete');

            if (del) {

                e.preventDefault();

                e.stopImmediatePropagation();

                const card = del.closest('.atendido-card');

                const id = parseInt(card?.dataset.id || '0', 10);

                let name = del.dataset.name;

                if (!name) {

                    const img = del.parentElement?.querySelector('img');

                    const src = img ? img.getAttribute('src') || '' : '';

                    name = src.split('/').pop();

                }

                if (id && name) {

                    deletePersistedPhoto(id, name);

                }

            }

        }, true);



        // ====== Lightbox (fullscreen/download) ======

        function openLightbox(src) {

            const overlay = document.getElementById('lightboxOverlay');

            const img = overlay ? overlay.querySelector('.lightbox-img') : null;

            const dl = overlay ? overlay.querySelector('.lightbox-download') : null;

            if (!overlay || !img || !dl) return;

            img.src = src;

            try {

                const url = new URL(src, window.location.origin);

                const name = (url.pathname.split('/').pop() || 'imagem').split('?')[0];

                dl.href = src;

                dl.setAttribute('download', name || 'imagem');

            } catch (e) {

                dl.href = src;

                dl.setAttribute('download', 'imagem');

            }

            overlay.classList.add('show');

        }



        function closeLightbox() {

            const overlay = document.getElementById('lightboxOverlay');

            if (!overlay) return;

            const img = overlay.querySelector('.lightbox-img');

            if (img) img.src = '';

            overlay.classList.remove('show');

        }



        // Delegate clicks on zoomable images

        document.addEventListener('click', function(e) {

            const img = e.target.closest('img.zoomable');

            if (img) {

                openLightbox(img.src);

                return;

            }

            const overlay = document.getElementById('lightboxOverlay');

            if (overlay && overlay.classList.contains('show') && e.target === overlay) {

                closeLightbox();

            }

        });



        // Close on ESC

        document.addEventListener('keydown', function(e) {

            if (e.key === 'Escape') closeLightbox();

        });

    </script>

    <script>

        // Função global de voltar para usar o histórico

        function goBack() {

            window.history.back();

        }

    </script>

    <!-- Lightbox overlay -->

    <div id="lightboxOverlay" class="lightbox-overlay" aria-hidden="true">

        <div class="lightbox-content">

            <img class="lightbox-img" src="" alt="Visualizacao da imagem">

            <div class="lightbox-actions">

                <a class="btn btn-download lightbox-download" href="#" download>Baixar</a>

                <button type="button" class="btn btn-close" onclick="closeLightbox()">Fechar</button>

            </div>

        </div>

    </div>

</body>

</html>







